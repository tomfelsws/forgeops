#
# DS docker image build
#

# DS setup profile used during DS installation
docker/ds/bootstrap/setup-profiles/AM/config/6.5/base-entries.ldif
	dn: uid=am-config,ou=admins,&{AM_CONFIG_BASE_DN}
	userPassword: &{AM_CONFIG_ADMIN_PASSWORD}

# installation of DS during docker image build, setting values for setup proviles, overriding above defaults
docker/ds/bootstrap/setup-ds.sh
	--set am-cts/baseDn:${CTS_BASE_DN} \
	--set am-cts/amCtsAdminPassword:password \


#
# DS container "StatefulSet" as "configstore"
#

# secrets password value from DS helm chart
helm/ds/secrets/configstore.pw
	password-cs

# password update during DS pod 0 startup, using password secrets from helm chart
docker/ds/swissid/bin/swissid-lib.sh:
	CONFIGSTORE_PW=$( cat $SECRET_PATH/configstore.pw )
	uid=am-config,ou=admins,$BASE_DN
	userPassword: $CONFIGSTORE_PW


#
# amster container "Deployment"
#

# amster helm chart default values to connect to configstore via AM
helm/amster/values.yaml:
	dirManager: "uid=am-config,ou=admins,ou=am-config"
	password: password

# Gitlab amster helm chart actual values to connect to configstore via AM
config/swissid-gitlab/amster.yaml:
	ctsPassword: password
	dirManager: "uid=am-config,ou=admins,$CONFIGSTORE_BASE_DN"
	password: password-cs

# amster config map (00_install.amster script) used to connect to configstore via AM
helm/amster/templates/config-map.yaml:
	--cfgStoreDirMgr {{.Values.configStore.dirManager }}
	--cfgStoreDirMgrPwd {{.Values.configStore.password }}


#
# OpenAM container "Deployment"
#

# keystore holding the "configstorepwd" alias that has the encrypted password
# this must also be changed when updating the password in helm/ds/secrets/configstore.pw
# https://backstage.forgerock.com/docs/am/6.5/maintenance-guide/#create-password-strings
helm/openam/secrets/keystore.jceks:
	"configstorepwd" alias (with "password" as default value from forgerock

# script to generate keystore.jceks entries
bin/generate-secrets.sh:
	CONFIGSTORE_PW="password"
	DSAME_PW="password"
	echo ${CONFIGSTORE_PW} | keytool -importpass -alias  configstorepwd \
		-storetype ${TYPE} -keystore ${KEYSTORE} -storepass ${STORE_PASS} -keypass ${STORE_PASS}
	echo ${DSAME_PW} | keytool -importpass -alias dsameuserpwd  \
		-storetype ${TYPE} -keystore ${KEYSTORE} -storepass ${STORE_PASS} -keypass ${STORE_PASS}

# AM boot.json file, values to connect to configstore
# tries to connect to configstore using the DN from boot.json and password from keystore file ("configstorepwd" alias)
helm/openam/templates/config-map.yaml:
	"dsameUser" : "cn=dsameuser,ou=DSAME Users,{{ .Values.rootSuffix }}",
	"dirManagerDN" : "uid=am-config,ou=admins,ou=am-config",
         "keyStoreFile" : "/home/forgerock/openam/keystore.jceks"

# AM bootstrap init container copying keystore.jceks to correct location
docker/util/am_bootstrap.sh:
	cp  -L /var/run/secrets/openam/keystore.jceks "${OPENAM_HOME}"
        cp -L /var/run/openam/*.json "$OPENAM_HOME"
